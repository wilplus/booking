// Booking system â€” PostgreSQL (Supabase). Do not modify existing tables if any.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Teacher {
  id                    String              @id @default(cuid())
  email                 String              @unique
  name                  String
  bio                   String?
  photoUrl              String?
  googleAccessToken     String?
  googleRefreshToken    String?
  googleCalendarId      String?
  stripePaymentLink     String?
  postSessionMessage    String?
  bufferMinutes         Int                 @default(0)
  minNoticeHours        Int                 @default(24)
  maxAdvanceBookingDays Int                 @default(28)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  availability          WeeklyAvailability[]
  dateOverrides         DateOverride[]
  lessonTypes           LessonType[]
  bookings              Booking[]
}

model WeeklyAvailability {
  id        String   @id @default(cuid())
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  dayOfWeek Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime String   // "10:00" in HH:mm format, teacher's local time
  endTime   String   // "20:30" in HH:mm format
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, dayOfWeek])
}

model DateOverride {
  id        String   @id @default(cuid())
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  isBlocked Boolean  @default(true) // true = day off, false = custom hours
  startTime String?  // only if isBlocked=false
  endTime   String?  // only if isBlocked=false
  reason    String?  // "Vacation", "Holiday", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, date])
}

model LessonType {
  id          String    @id @default(cuid())
  teacherId   String
  teacher     Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  duration    Int       // 30, 60, or 90 minutes
  price       Float     // price in EUR or relevant currency
  currency    String    @default("EUR")
  isActive        Boolean          @default(true)
  bookings        Booking[]
  recurringSeries RecurringSeries[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([teacherId, duration])
}

model Booking {
  id                   String           @id @default(cuid())
  teacherId            String
  teacher              Teacher          @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  lessonTypeId         String
  lessonType           LessonType       @relation(fields: [lessonTypeId], references: [id], onDelete: Restrict)
  clientName           String
  clientEmail          String
  clientTimezone       String           // e.g., "Europe/Warsaw"
  startTime            DateTime         // UTC
  endTime              DateTime         // UTC
  status               BookingStatus    @default(CONFIRMED)
  meetLink             String?
  googleEventId        String?
  managementToken      String           @unique @default(cuid())
  recurringSeriesId    String?
  recurringSeries      RecurringSeries? @relation(fields: [recurringSeriesId], references: [id], onDelete: SetNull)
  cancelledAt          DateTime?
  rescheduledFrom      String?          // original booking ID if this is a reschedule
  reminder24hSent       Boolean          @default(false)
  reminder1hSent        Boolean          @default(false)
  postSessionEmailSent Boolean          @default(false)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  @@index([teacherId, startTime])
  @@index([clientEmail])
  @@index([managementToken])
}

model RecurringSeries {
  id              String    @id @default(cuid())
  clientName      String
  clientEmail     String
  clientTimezone  String
  lessonTypeId    String
  lessonType      LessonType @relation(fields: [lessonTypeId], references: [id], onDelete: Cascade)
  dayOfWeek       Int       // 0-6
  startTimeLocal  String    // "15:00" in client's timezone
  isActive        Boolean   @default(true)
  bookings        Booking[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
  RESCHEDULED
}
